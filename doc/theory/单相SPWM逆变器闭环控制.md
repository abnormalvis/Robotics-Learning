
# 单相 SPWM 逆变器闭环控制：应用场景、理论与工程落地

这篇笔记面向“能做出来、能调通、能量产前评估风险”的视角，讲清楚：

- 单相 SPWM 逆变器常见**应用场景**与控制目标
- 典型功率级（全桥 + 滤波）从哪里来的**简化模型**
- 工程里最常用的几种**闭环结构**（电压外环/电流内环、PR 控制、前馈）
- 上板/上机调试时最容易踩的坑（死区、采样、饱和、保护、EMI）

> 说明：这里的“SPWM”强调的是**正弦脉宽调制**作为调制方式；闭环控制是另一个维度（控制器决定调制指令）。工程上也常见 SVPWM、单极性 PWM、三电平等，思路类似。

---

## 1. 应用场景：为什么要做闭环

单相逆变器输出常见目标是：稳定的 50/60 Hz 正弦电压，或可控的交流电流。

### 1.1 常见应用

- **UPS/离线或在线不间断电源**：市电断电时维持 220 Vrms/110 Vrms 输出；负载可能从空载到整流电容负载突变。
- **光伏/储能并网或离网**：并网时需要精确电流控制、同步相位；离网时更像“电压源”。
- **车载/便携逆变器**：DC（电池）→ AC，强调体积、效率、低成本；负载非线性很强。
- **AC 电源/电子负载前端**：需要低 THD、稳幅稳频、可编程输出。

### 1.2 为什么开环（纯 SPWM）不够

如果你只做开环：给一个固定调制度 $m$，输出电压近似与母线电压 $V_{dc}$ 成比例。

但现实里：

- $V_{dc}$ 会波动（电池掉压、PFC 不稳、纹波）
- 负载会变化（尤其整流+大电容负载会拉出尖峰电流）
- 功率器件与磁件有非理想（死区、压降、磁饱和）
- 滤波器带来动态（LC 共振、相位滞后）

闭环的目标是：**让输出量（电压/电流）对上述变化“不敏感”**。

---

## 2. 系统结构：功率级 + 采样 + 调制

最典型的单相 SPWM 逆变器功率级：

```
	 Vdc
		|
	[Full-Bridge]  -> v_ab(t)  ->  [L 或 LCL/LC 滤波]  -> v_o(t) -> 负载
		|
	 GND
```

控制与采样链路通常包含：

- 采样：$v_o$（输出电压）、$i_L$（电感电流）/ $i_o$（输出电流）、$V_{dc}$（母线）
- 控制器：电压环/电流环（数字控制常见）
- 调制器：把控制器输出转成 PWM 占空比（单极性/双极性 SPWM）
- 驱动与保护：死区、过流比较器、欠压锁定、温度保护

---

## 3. SPWM 与输出基波：你控制的“到底是什么”

以全桥为例，设 PWM 载波三角波幅值归一化，参考正弦为 $v_{ref}(t)=m\sin(\omega t)$。

常见结论（用于建立直觉，不当作严格推导）：

- **双极性 SPWM**：桥臂输出在 $\pm V_{dc}$ 两电平切换，基波幅值与 $mV_{dc}$ 相关。
- **单极性 SPWM**：等效开关频率更高、谐波分布更友好，常用在单相全桥。

闭环控制做的事是：通过调节 $m$（或更一般的调制指令）让输出电压/电流满足目标。

因此工程里经常会把“调制器”看成一个近似增益环节：

$$
v_{ab,1}(t) \approx K_m\,m(t)\,V_{dc}(t)
$$

其中 $K_m$ 与调制方式、定义有关（单极性/双极性、峰值/有效值）。你不必死抠系数，关键是：

- **$V_{dc}$ 的变化会直接乘到输出上** → 需要母线前馈/闭环补偿
- **$m$ 有饱和**（$|m|\le 1$ 或留余量）→ 大扰动时会顶死

---

## 4. 小信号模型（够用版）：L 或 LC 滤波

不同滤波决定控制难度：

- **L 滤波**：结构简单，适合电流源型（并网电流控制）或简单电压源（配合电压环）
- **LC 滤波**：输出电压波形更干净，但有共振，需要阻尼或控制策略处理
- **LCL**：并网常用，三阶且共振更尖锐，控制更讲究

这里先给最常见的 **LC 滤波电压源**思路（UPS/离网很典型）。

设：

- $L$：滤波电感
- $C$：滤波电容
- $v_{inv}$：逆变器等效输出（基波/平均意义下）
- $v_o$：输出电压（电容两端）
- $i_L$：电感电流
- $i_o$：负载电流（扰动源）

连续时间平均模型：

$$
\begin{aligned}
L\,\dot i_L &= v_{inv} - v_o \\
C\,\dot v_o &= i_L - i_o
\end{aligned}
$$

你会立刻看到一个关键事实：

- 负载电流 $i_o$ 直接进入输出电压动态 → **这是最主要的扰动通道**。

因此工程上经常会加：

- **负载电流前馈**（若测得到 $i_o$ 或近似得到）
- 或者更常见：做**电流内环**，让 $i_L$ 能快速跟踪，从而把 $i_o$ 的影响压下去

---

## 5. 闭环控制结构：从简单到强

### 5.1 结构 A：单电压环（最简单，但最难扛非线性负载）

```
v_ref -> [电压控制器] -> v_inv_cmd -> [PWM/功率级+滤波] -> v_o
													^
													|
												v_o
```

优点：结构简单、传感器少。

缺点：

- LC/负载造成的相位滞后大，电压环容易不稳
- 负载突变时恢复慢
- 整流+电容类负载会引入强非线性，电压环难调

适用：负载变化小、性能要求不高的场景。

### 5.2 结构 B：电流内环 + 电压外环（工程最常用）

```
v_ref -> [电压外环] -> i_L_ref -> [电流内环] -> v_inv_cmd -> 功率级 -> v_o
																	^                              |
																	|                              |
																 i_L                            采样
```

直观理解：

- 电流内环把“功率级 + L”变成一个**快的可控执行器**
- 电压外环只需要管“C 上的电压”并通过 $i_L$ 来调

优点：

- 动态快、抗负载扰动强
- 更容易把 LC 共振压住（配合阻尼/控制设计）

代价：需要电流采样，控制更复杂。

### 5.3 结构 C：并网电流控制（电流源型）

并网时，常见目标是让输出电流跟踪正弦并与电网同步：

- 控制量：并网电流 $i_g$
- 被控对象：L 或 LCL
- 需要相位/频率同步（PLL 或 SOGI-PLL）

这类属于“电流控制为主”，电压环通常不存在或只用于 DC 母线侧。

---

## 6. 为什么交流系统常用 PR 控制器（而不是只用 PI）

很多人第一次做闭环会直觉用 PI。

- 对 **直流**跟踪，PI 很强（积分消除静差）。
- 但对 **50/60 Hz 正弦**跟踪，PI 在静止坐标系下并不能保证在 $\omega$ 处零稳态误差。

### 6.1 PR 控制器的核心特性

PR（Proportional-Resonant）在目标频率 $\omega_0$ 处提供很高增益，使得对 $\sin(\omega_0 t)$ 的跟踪/抑制误差能力类似“对直流的积分”。

理想 PR：

$$
G_{PR}(s)=k_p + k_r\frac{s}{s^2+\omega_0^2}
$$

工程上会做“带宽化”（避免无限尖峰）：

$$
G_{PR}(s)=k_p + k_r\frac{2\omega_c s}{s^2+2\omega_c s+\omega_0^2}
$$

- $\omega_0$：目标基波角频率（$2\pi\cdot 50$ 或 $2\pi\cdot 60$）
- $\omega_c$：谐振项带宽（越大越不尖锐、越抗频偏，但选择不当会引入相位问题）

### 6.2 什么时候 PR 特别有用

- 输出电压要低 THD、稳幅稳频（离网 UPS）
- 并网电流跟踪（静止坐标系实现简单）

如果你愿意引入同步坐标系（dq），也可以用“正交信号生成 + dq PI”，但单相实现需要 SOGI/OSG，工程链路会更长。

---

## 7. 一个典型“电压外环 + 电流内环”的控制思路（可落地）

以 LC 输出为例。

### 7.1 电流内环（让 $i_L$ 快速跟踪）

由

$$
L\,\dot i_L = v_{inv} - v_o
$$

可以做一个很常见的前馈解耦：

$$
v_{inv,cmd} = v_o + v_{L,cmd}
$$

其中 $v_{L,cmd}$ 用来实现电流闭环，例如用 PR（跟踪正弦电流）或用 PI（如果你把电流参考做成正弦且用 PR 更合适）。

电流环里加 $v_o$ 前馈的好处是：把对象从“$v_{inv}$ 到 $i_L$”的扰动项消掉一部分，让电流环更像一阶。

### 7.2 电压外环（生成 $i_L$ 参考）

由

$$
C\,\dot v_o = i_L - i_o
$$

电压环的控制输出是 $i_L^*$。这里也常用 PR（跟踪正弦电压）或“基波幅值控制 + 波形发生”。

工程中常见做法之一：

- 令 $v_{ref}(t)=V^*\sin(\omega_0 t)$
- 计算误差 $e_v=v_{ref}-v_o$
- 电压 PR 输出给出 $i_L^*$

这样结构清晰、调参直观。

### 7.3 带宽怎么选（经验但很实用）

没有统一答案，但有几条“少走弯路”的经验约束：

- **采样/计算延迟**会吃相位：控制带宽别太接近采样频率。
- **开关频率 $f_s$**决定你能做到多快：控制带宽通常远小于 $f_s$。
- **LC 共振频率 $f_r$**要避开：带宽不要顶到共振附近。

常用的起步经验（按你系统噪声与裕量再调）：

- 电流内环带宽：$f_{ci}$ 取 $f_s$ 的 $1/10\sim 1/20$ 左右（先保守，再提速）。
- 电压外环带宽：$f_{cv}$ 取 $f_{ci}$ 的 $1/5\sim 1/10$。
- 若是 LC：尽量让 $f_{ci}$ 和 $f_{cv}$ 与 $f_r$ 保持足够间隔（不要贴着共振调）。

### 7.4 PR 控制器的离散实现（Tustin 模板，可直接写代码）

工程更常用“带宽化 PR”：

$$
G_{PR}(s)=k_p + k_r\frac{2\omega_c s}{s^2+2\omega_c s+\omega_0^2}
$$

将其写成“比例 + 二阶滤波器”的形式：

$$
u(s) = k_p e(s) + k_r\,x(s),\quad x(s)=\frac{2\omega_c s}{s^2+2\omega_c s+\omega_0^2}e(s)
$$

对二阶部分用双线性变换（Tustin）：

$$
s \leftarrow \frac{2}{T_s}\frac{1-z^{-1}}{1+z^{-1}}
$$

你最终会得到一个标准的 IIR 形式：

$$
x[n] = a_1 x[n-1] + a_2 x[n-2] + b_0 e[n] + b_1 e[n-1] + b_2 e[n-2]
$$

然后

$$
u[n] = k_p e[n] + k_r x[n]
$$

**推荐做法**：不要手推系数（容易错），而是在工程里固定采用一个“由连续域参数计算离散系数”的函数。

伪代码结构：

```text
struct PR {
	float kp, kr;
	float a1, a2, b0, b1, b2;
	float x1, x2;   # x[n-1], x[n-2]
	float e1, e2;   # e[n-1], e[n-2]
}

update(pr, e):
	x = pr.a1*pr.x1 + pr.a2*pr.x2 + pr.b0*e + pr.b1*pr.e1 + pr.b2*pr.e2
	u = pr.kp*e + pr.kr*x
	pr.x2=pr.x1; pr.x1=x
	pr.e2=pr.e1; pr.e1=e
	return u
```

系数 $(a_1,a_2,b_0,b_1,b_2)$ 的计算方式在不同推导下会有不同写法（但本质等价）。如果你告诉我：

- 你的 $T_s$、$\omega_0$（50/60Hz）、期望 $\omega_c$
- 你是用 PR 做电压环还是电流环

我可以把这一节补成“带具体公式的系数计算 + 示例数值”，并给出一份更贴近你控制平台（STM32/C2000）的 C 代码模板。

---

## 8. 关键工程细节：不解决这些，理论再美也会炸

### 8.1 采样与 PWM 同步（强烈建议）

数字控制里最常见的噪声/抖动来源之一是：采样点落在开关噪声最强的位置。

建议：

- ADC 采样与 PWM 定时器同步（在载波中心/固定相位采样）
- 电流采样尽量远离开关瞬态
- 采样延迟要算进控制环路（等效增加相位滞后）

### 8.2 死区（dead-time）与器件压降

死区会让输出出现等效电压误差，且与电流方向相关（非线性）。典型现象：

- 轻载时波形畸变明显
- 过零附近出现“台阶”

常见对策：

- 做死区补偿（基于电流方向修正占空比）
- 提高开关频率/优化驱动
- 允许一定 THD 时用闭环增益去“顶回去”（但会增加电流纹波和噪声）

### 8.3 母线电压前馈（非常关键）

因为调制近似满足 $v_{inv}\propto m V_{dc}$，所以 $V_{dc}$ 波动会直接映射到输出。

常见做法：

- 控制器输出的是期望 $v_{inv,cmd}$
- 调制前用 $V_{dc}$ 做归一化：
	$$
	m = \mathrm{sat}\left(\frac{v_{inv,cmd}}{V_{dc}}\right)
	$$

这样母线掉压时，系统会自动提高 $m$（直到饱和）。

### 8.4 饱和与限幅：必须“设计进去”

- $m$ 必然有限幅，且通常要留裕量（给死区补偿、非理想、过调制风险）
- 电流/电压环要做 anti-windup（尤其 PR/PI 类有积分/谐振累积效应）

### 8.5 保护：过流是第一生命线

工程上常见两级保护：

- **硬件快速过流**：比较器 + 关断（ns~us 级）
- **软件限流**：控制器限制 $i_L^*$ 或占空比（ms 级）

两者缺一不可：软件再快也敌不过短路时的 di/dt。

### 8.6 LC 共振与阻尼

LC 会有共振频率：

$$
\omega_r = \frac{1}{\sqrt{LC}}
$$

如果共振频率接近控制带宽或采样频率的某些位置，容易振。

对策：

- 在控制器里加虚拟阻尼（例如电容电流反馈、或在电压环/电流环加入阻尼项）
- 物理阻尼（串/并电阻）但会损耗效率
- 控制带宽避开共振点

---

## 9. 调试/上板流程（强烈建议按顺序）

1. **先验证功率级与驱动**：空载低压母线，确认波形、死区、互补、无直通。
2. **只开调制，不闭环**：输出占空比小，确认滤波后波形、采样通道量程/极性。
3. **先闭电流内环**：给小幅正弦/限幅参考，确认电流能稳定跟踪、不过流。
4. **再闭电压外环**：从小电压起步，逐步升高到目标；观察输出 THD 与动态。
5. **做负载阶跃测试**：电阻负载 → 整流电容负载 → 冲击负载；检查恢复与保护。
6. **最后做母线扰动与温升**：掉压、纹波、满载热测试。

---

## 10. 常见“症状 → 原因 → 处理”速查

- 输出正弦畸变、过零台阶：死区/压降/采样噪声 → 死区补偿、同步采样、降低 $\omega_o/\omega_c$（若你用了观测器）
- 轻载振铃：LC 共振 + 环路相位不足 → 加阻尼、降低带宽、调整 PR 带宽 $\omega_c$
- 一加负载就掉压：电压环太慢或电流限幅太紧 → 提高外环带宽/限流策略改造
- 大电容负载时尖峰过流：缺少限流/软启动 → 加电流限幅、输出缓升、预充电

---

## 11. 你想深入哪个方向（我可以按你的项目再补一版）

如果你告诉我下面这些信息，我可以把本页继续扩展成“可直接算参数/可直接写代码”的版本：

- 拓扑：全桥？半桥？单极性还是双极性 PWM？
- 滤波：L/LC/LCL 的参数（$L,C$）以及开关频率 $f_s$
- 目标：离网稳压（220 Vrms/50 Hz）还是并网控流？
- 采样：采的是 $i_L$ 还是 $i_o$？电压采样位置？
- 控制平台：STM32/C2000/FPGA/Linux？采样频率与 PWM 同步方式？

我也可以按你的偏好补充：

- PR 控制器离散化（Tustin）与系数计算模板
- 单相 SOGI-PLL（并网同步）
- 死区补偿的常用实现

