wheel_pid_controller:
  # - rqt_reconfigure 使用一组扁平的动态参数键（如 wheel_fl_p、pivot_fr_i_clamp）。
  # - 本 YAML 使用分层键（wheels/wheel_fl/p 等）作为启动默认值。
  # - 运行时我们会把动态参数"镜像回写"到对应的分层键上，便于 rosparam get 旧路径看到最新值；
  #   但这不会自动写回文件。如需持久化，请在运行后使用 rosparam/dynparam dump 导出。
  
  # 控制器描述
  type: "sentry_chassis_controller/WheelPidController"
  cmd_vel_topic: "/cmd_vel" # 参数服务器中的 cmd_vel 主题
  synthetic_fallback: false
  speed_mode: "local"
  # 坐标系名称
  odom_frame: "odom"
  base_link_frame: "base_link"
  # TF 发布控制（使用gazebo中的Ground Truth插件或使用到imu时设为 false）
  publish_tf: true
  #  底盘物理参数 
  wheel_track: 0.36
  wheel_base: 0.36
  wheel_radius: 0.05
  #  状态反馈配置（来自 state_fix） 
  joint_state_controller:
    publish_rate: 10
  enable_state_feedback: true
  joint_names_reported:
    - left_front_wheel_joint
    - right_front_wheel_joint
    - left_back_wheel_joint
    - right_back_wheel_joint
    - left_front_pivot_joint
    - right_front_pivot_joint
    - left_back_pivot_joint
    - right_back_pivot_joint
  #  默认 PID 参数（回退值） 
  pivot:
    p: 1.3
    i: 0.02
    d: 0.25
    i_clamp: 0.3
    antiwindup: 0.0
    output_min: -5.0
    output_max: 5.0
  wheel:
    p: 0.7
    i: 0.05
    d: 0.2
    i_clamp: 0.2
    antiwindup: 0.0
    output_min: -10.0
    output_max: 10.0
    lpf_tau: 0.02  # 低通滤波器时间常数 (s)，0表示默认禁用

  #  轮子名称列表 
  wheel_names:
    - wheel_fl
    - wheel_fr
    - wheel_rl
    - wheel_rr
    - pivot_fl
    - pivot_fr
    - pivot_rl
    - pivot_rr

  #  每轮独立 PID 配置 
  wheels:
    # ---------- 驱动轮 PID ----------
    wheel_fl:
      p: 0.7
      i: 0.05
      d: 0.2
      i_clamp: 0.2
      output_min: -10.0
      output_max: 10.0
      lpf_tau: 0.02  # 低通滤波器时间常数 (s)
    wheel_fr:
      p: 0.7
      i: 0.05
      d: 0.2
      i_clamp: 0.2
      output_min: -10.0
      output_max: 10.0
      lpf_tau: 0.02
    wheel_rl:
      p: 0.7
      i: 0.05
      d: 0.2
      i_clamp: 0.2
      output_min: -10.0
      output_max: 10.0
      lpf_tau: 0.02
    wheel_rr:
      p: 0.7
      i: 0.05
      d: 0.2
      i_clamp: 0.2
      output_min: -10.0
      output_max: 10.0
      lpf_tau: 0.02

    # ---------- 舵轮 PID ----------
    pivot_fl:
      p: 1.3
      i: 0.02
      d: 0.25
      i_clamp: 0.3
      output_min: -5.0
      output_max: 5.0
    pivot_fr:
      p: 1.3
      i: 0.02
      d: 0.25
      i_clamp: 0.3
      output_min: -5.0
      output_max: 5.0
    pivot_rl:
      p: 1.3
      i: 0.02
      d: 0.25
      i_clamp: 0.3
      output_min: -5.0
      output_max: 5.0
    pivot_rr:
      p: 1.3
      i: 0.02
      d: 0.25
      i_clamp: 0.3
      output_min: -5.0
      output_max: 5.0

  # 若要让 s=1 成为“边界”（即在当前命令下恰触发限制），需满足 a + b + c = 0，因 b 与 # c 已由观测近似给出，所以需要把 a 调整为：
  # a_needed = −b − c = −0.0079767 + 299.9999995 = 299.9920228 ≈ 300。
  # 于是所需的 effort_coeff_new = a_needed / (cmd^2 之和)
  # 功率限制配置 
  power_limit: 480.0  # 假设每个电机24V5A 为上限
  power:
    effort_coeff: 93.1
    velocity_coeff: 0.0048
    power_offset: 0.0
  power_debug: true

  #  底盘自锁功能（几何自锁） 
  self_lock:
    enabled: true
    idle_timeout: 0.5
    velocity_deadband: 0.05
    
    # 自锁模式
    geo_lock_wheel_brake: true
    
    # 自锁时是否锁胎
    lock_pos_p: 3.0
    lock_pos_d: 0.5
    max_lock_torque: 30.0

  #  舵轮同步检查（防止偏航） 
  # 问题：舵轮未到位就驱动轮子会导致车辆偏航
  # 方案：根据舵角误差动态缩放轮速命令
  pivot_sync:
    enabled: true              # 启用舵轮同步检查
    threshold: 0.15            # 舵角同步阈值（rad，约8.6°）
    scale_min: 0.1             # 最小轮速缩放（0.1 = 舵角误差大时只有10%轮速）
