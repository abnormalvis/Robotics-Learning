# Pull Request: Teleop Enhancements & Power Control Improvements

## ğŸ“‹ æ¦‚è¿°

æœ¬PRåŒ…å«å¯¹å“¨å…µåº•ç›˜æ§åˆ¶å™¨çš„é‡è¦åŠŸèƒ½å¢å¼º,ä¸»è¦æ¶‰åŠé”®ç›˜é¥æ“ä½œèŠ‚ç‚¹çš„æ¨¡å—åŒ–é‡æ„ã€åŠŸç‡é™åˆ¶ç³»ç»Ÿçš„è°ƒè¯•åŠŸèƒ½ä»¥åŠç­”è¾©å‡†å¤‡æ–‡æ¡£ã€‚

## ğŸ¯ ä¸»è¦å˜æ›´

### 1. é”®ç›˜é¥æ“ä½œèŠ‚ç‚¹æ¨¡å—åŒ–é‡æ„

**æ–‡ä»¶**:
- `src/sentry_control_key_modular.cpp` (æ–°å¢)
- `src/keyboard_input.cpp` (æ–°å¢)
- `src/teleop_state_machine.cpp` (æ–°å¢)
- `src/teleop_node.cpp` (æ–°å¢)
- `src/velocity_calculator.cpp` (æ–°å¢)
- `include/sentry_chassis_controller/*.hpp` (å¯¹åº”å¤´æ–‡ä»¶)

**æ”¹è¿›**:
- âœ… è§£è€¦é”®ç›˜è¾“å…¥ã€çŠ¶æ€æœºã€é€Ÿåº¦è®¡ç®—é€»è¾‘
- âœ… æ·»åŠ å®æ—¶é€Ÿåº¦è°ƒèŠ‚åŠŸèƒ½ (u/i/o/p é”®)
  - u/i: è°ƒèŠ‚å¹³ç§»é€Ÿåº¦ Â±0.1 m/s (èŒƒå›´ 0.1~5.0)
  - o/p: è°ƒèŠ‚è§’é€Ÿåº¦ Â±0.1 rad/s (èŒƒå›´ 0.1~5.0)
- âœ… ç§»é™¤è¶…æ—¶è‡ªåŠ¨åœæ­¢æœºåˆ¶(ä¸åŸå§‹èŠ‚ç‚¹è¡Œä¸ºä¸€è‡´)
- âœ… æŒç»­å‘å¸ƒé€Ÿåº¦å‘½ä»¤ç¡®ä¿æ§åˆ¶å™¨å®æ—¶å“åº”
- âœ… æ”¹è¿›ä»£ç å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§

### 2. åŠŸç‡é™åˆ¶ç³»ç»Ÿå¢å¼º

**æ–‡ä»¶**:
- `src/power_limiter.cpp`
- `src/wheel_pid_controller.cpp`
- `cfg/WheelPid.cfg`

**æ”¹è¿›**:
- âœ… æ‰©å±• `/power_debug` è¯é¢˜è¾“å‡ºä» 5 ä¸ªå­—æ®µå¢åŠ åˆ° 12 ä¸ªå­—æ®µ:
  - `data[0]`: äºŒæ¬¡é¡¹ç³»æ•° a
  - `data[1]`: ä¸€æ¬¡é¡¹ç³»æ•° b  
  - `data[2]`: å¸¸æ•°é¡¹ c
  - `data[3]`: åˆ¤åˆ«å¼ discriminant
  - `data[4]`: ç¼©æ”¾å› å­ scaling_factor
  - `data[5]`: F(1) éªŒè¯å€¼
  - `data[6]`: sum_cmd_squared
  - `data[7]`: sum_vel_squared
  - `data[8]`: æ ¹ r1
  - `data[9]`: æ ¹ r2
  - `data[10]`: æ˜¯å¦è¢«é™åˆ¶æ ‡å¿—
  - `data[11]`: b å¤‡ä»½å€¼
- âœ… æ·»åŠ  dynamic_reconfigure æ”¯æŒ:
  - `effort_coeff`: åŠ›çŸ©ç³»æ•°(æ¨è 90-100)
  - `velocity_coeff`: é€Ÿåº¦ç³»æ•°(é»˜è®¤ 0.0048)
  - `power_limit`: åŠŸç‡é™åˆ¶(é»˜è®¤ 300W)
  - `power_offset`: åŠŸç‡åç§»
- âœ… å®æ—¶å‚æ•°è°ƒèŠ‚æ— éœ€é‡å¯èŠ‚ç‚¹
- âœ… æ·»åŠ è¯¦ç»†çš„å…¬å¼æ³¨é‡Šå’Œæ•°å€¼ç¤ºä¾‹

### 3. ç­”è¾©å‡†å¤‡æ–‡æ¡£

**æ–‡ä»¶**:
- `docs/defense_questions.md` (134é“é—®é¢˜)
- `docs/defense_answers.md` (å®Œæ•´ç­”æ¡ˆ)
- `docs/power_visualization_guide.md` (åŠŸç‡æ¨¡å‹æ¨å¯¼)
- `docs/modular_teleop_update.md` (æ¨¡å—åŒ–é‡æ„è¯´æ˜)

**å†…å®¹**:
- âœ… 12ä¸ªä¸“é¢˜134é“ç­”è¾©é—®é¢˜
- âœ… ros_controlæ¡†æ¶åŸç†
- âœ… èˆµè½®è¿åŠ¨å­¦ä¸180Â°ç¿»è½¬å¤„ç†
- âœ… PIDæ§åˆ¶ä¸è°ƒå‚ç­–ç•¥
- âœ… åŠŸç‡é™åˆ¶ç‰©ç†æ¨¡å‹æ¨å¯¼(é“œæŸ+æœºæ¢°åŠŸ+é“æŸ)
- âœ… é‡Œç¨‹è®¡æ ‡å®šä¸çŸ«æ­£æ–¹æ³•
- âœ… ä»£ç å®ç°ç»†èŠ‚(è¾¹ç•Œå¤„ç†ã€æ€§èƒ½ä¼˜åŒ–)
- âœ… æ•°å€¼ç¤ºä¾‹å’Œè°ƒè¯•æŠ€å·§

### 4. å…¶ä»–æ”¹è¿›

**GeoLock & OdomUpdater æ¨¡å—åŒ–**:
- `src/geo_lock.cpp` - è‡ªé”åŠŸèƒ½ç‹¬ç«‹æ¨¡å—
- `src/odom_updater.cpp` - é‡Œç¨‹è®¡æ›´æ–°ç‹¬ç«‹æ¨¡å—
- `src/low_pass_filter.cpp` - ä½é€šæ»¤æ³¢å™¨ç‹¬ç«‹æ¨¡å—

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### åŠŸç‡æ¨¡å‹å…¬å¼
```
P(s) = effort_coeff * Î£(cmd_iÂ²) + Î£(|cmd_i * vel_i|) + velocity_coeff * Î£(vel_iÂ²) - offset - limit
     = a*sÂ² + b*s + c

å½“ P(s) > 0 æ—¶æ±‚è§£: s = (-b - âˆšÎ”) / (2a)
```

### PivotåŒæ­¥æœºåˆ¶
```cpp
// çº¿æ€§æ’å€¼å…¬å¼(é™„4ä¸ªæ•°å€¼ç¤ºä¾‹)
t = (max_error - threshold) / (Ï€ - threshold)  // å½’ä¸€åŒ–åˆ° [0,1]
pivot_sync_scale = 1.0 - t * (1.0 - scale_min) // æ’å€¼åˆ° [1.0, scale_min]
```

## ğŸ§ª æµ‹è¯•éªŒè¯

- âœ… ç¼–è¯‘é€šè¿‡: `catkin build sentry_chassis_controller`
- âœ… æ— ç¼–è¯‘é”™è¯¯æˆ–è­¦å‘Š
- âœ… é”®ç›˜èŠ‚ç‚¹åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… é€Ÿåº¦è°ƒèŠ‚åŠŸèƒ½æ­£å¸¸
- âœ… `/power_debug` è¯é¢˜æ­£ç¡®å‘å¸ƒ12å­—æ®µæ•°æ®
- âœ… dynamic_reconfigure å‚æ•°å®æ—¶è°ƒèŠ‚æ­£å¸¸

## ğŸ“Š å½±å“èŒƒå›´

### æ–°å¢åŠŸèƒ½(æ— ç ´åæ€§å˜æ›´)
- âœ… æ¨¡å—åŒ–é”®ç›˜èŠ‚ç‚¹(åŸèŠ‚ç‚¹ä¿ç•™)
- âœ… åŠŸç‡è°ƒè¯•è¯é¢˜æ‰©å±•(å‘åå…¼å®¹)
- âœ… åŠ¨æ€å‚æ•°é…ç½®(å¯é€‰åŠŸèƒ½)

### ä¿æŒå…¼å®¹
- âœ… åŸæœ‰æ§åˆ¶å™¨æ¥å£ä¸å˜
- âœ… åŸæœ‰launchæ–‡ä»¶å…¼å®¹
- âœ… åŸæœ‰å‚æ•°é…ç½®å…¼å®¹

## ğŸ“ ä½¿ç”¨æŒ‡å—

### å¯åŠ¨æ¨¡å—åŒ–é”®ç›˜èŠ‚ç‚¹
```bash
rosrun sentry_chassis_controller sentry_control_key_modular
```

### ç›‘æ§åŠŸç‡è°ƒè¯•ä¿¡æ¯
```bash
rostopic echo /power_debug
rqt_plot /power_debug/data[4]  # æŸ¥çœ‹scaling_factor
```

### åŠ¨æ€è°ƒèŠ‚åŠŸç‡å‚æ•°
```bash
rosrun rqt_reconfigure rqt_reconfigure
# åœ¨GUIä¸­è°ƒèŠ‚ effort_coeff, power_limit ç­‰å‚æ•°
```

## ğŸ“ ç­”è¾©ææ–™

æ‰€æœ‰ç­”è¾©å‡†å¤‡æ–‡æ¡£ä½äº `docs/` ç›®å½•:
- é—®é¢˜ä¸ç­”æ¡ˆ: `defense_questions.md` & `defense_answers.md`
- åŠŸç‡æ¨¡å‹æ¨å¯¼: `power_visualization_guide.md`
- é‡æ„è¯´æ˜: `modular_teleop_update.md`

## ğŸ”— ç›¸å…³Commit

1. **477e205**: update teleop node (æ¨¡å—åŒ–é”®ç›˜èŠ‚ç‚¹æ›´æ–°)
2. **b1eceeb**: update support for dynamically change power limit params and teleop node
3. **fe08a4e**: decoupled teleop controller (åˆå§‹è§£è€¦)

## âœ… Checklist

- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [x] åŠŸèƒ½æµ‹è¯•å®Œæˆ
- [x] æ–‡æ¡£æ›´æ–°å®Œæ•´
- [x] æ— ç ´åæ€§å˜æ›´
- [x] å‘åå…¼å®¹
- [x] ä»£ç æ³¨é‡Šå……åˆ†
- [x] æ·»åŠ ä½¿ç”¨ç¤ºä¾‹

## ğŸ™ å®¡é˜…è¦ç‚¹

è¯·é‡ç‚¹å…³æ³¨:
1. æ¨¡å—åŒ–è®¾è®¡æ˜¯å¦åˆç†
2. åŠŸç‡è°ƒè¯•å­—æ®µæ˜¯å¦è¶³å¤Ÿ
3. dynamic_reconfigureå‚æ•°æ˜¯å¦å®Œæ•´
4. æ–‡æ¡£æ˜¯å¦æ¸…æ™°æ˜“æ‡‚
5. æ˜¯å¦æœ‰é—æ¼çš„è¾¹ç•Œæƒ…å†µ

---

**æäº¤è€…**: @abnormalvis  
**åˆ†æ”¯**: `feature/teleop-enhancements`  
**ç›®æ ‡åˆ†æ”¯**: `main`  
**ç±»å‹**: Feature Enhancement & Documentation
